<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      padding: 20px;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    button {
      border-radius: 6px;
      padding: 8px 16px;
      background: #18A0FB;
      color: white;
      border: none;
      cursor: pointer;
      width: 100%;
    }

    button:hover {
      background: #0D8EE9;
    }

    select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #E5E5E5;
    }

  </style>
</head>

<body>
  <div class="container">
    <select id="collection">
      <option value="new">Create new collection</option>
    </select>
    <button id="create">Create Variable</button>
  </div>
  <script>
    // Initialize by requesting collections
    parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');

    // Handle collections data
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'update-collections') {
        updateCollectionsDropdown(msg.collections);
      } else if (msg.type === 'collection-created') {
        // Add the newly created collection to the dropdown and select it
        addNewCollectionToDropdown(msg.collection);
      }
    };

    function updateCollectionsDropdown(collections) {
      const select = document.getElementById('collection');
      select.innerHTML = '';
      
      // Add existing collections first
      collections.forEach(collection => {
        const option = document.createElement('option');
        option.value = collection.id;
        option.textContent = collection.name;
        select.appendChild(option);
      });
      
      // Add "Create new collection" option at the end
      const newOption = document.createElement('option');
      newOption.value = 'new';
      newOption.textContent = 'Create new collection';
      select.appendChild(newOption);
    }

    function addNewCollectionToDropdown(newCollection) {
      const select = document.getElementById('collection');
      
      // Remove the "Create new collection" option temporarily
      const createNewOption = select.querySelector('option[value="new"]');
      if (createNewOption) {
        createNewOption.remove();
      }
      
      // Add the new collection
      const option = document.createElement('option');
      option.value = newCollection.id;
      option.textContent = newCollection.name;
      option.selected = true; // Select the newly created collection
      select.appendChild(option);
      
      // Re-add "Create new collection" option at the end
      const newOption = document.createElement('option');
      newOption.value = 'new';
      newOption.textContent = 'Create new collection';
      select.appendChild(newOption);
    }

    document.getElementById('create').onclick = () => {
      const collectionId = document.getElementById('collection').value;
      parent.postMessage({
        pluginMessage: {
          type: 'create-variable',
          collectionId
        }
      }, '*');
    };
  </script>
</body>

</html>
