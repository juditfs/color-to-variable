<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      padding: 12px;
      margin: 0;
      font-size: 11px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 24px);
    }

    .form-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 12px;
      margin-bottom: 12px;
    }

    .plugin-description {
      font-size: 11px;
      /* color: #666; */
      line-height: 1.4;
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-weight: 500;
      color: #7f7f7f;
      font-size: 11px;
    }

    select,
    input[type="text"] {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #E5E5E5;
      font-size: 11px;
      font-family: Inter, sans-serif;
    }

    select {
      /* Hide default arrow */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      /* Add custom smaller arrow with right padding */
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 6"><path fill="none" stroke="%23666" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M2 2l3 3 3-3"/></svg>');
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 8px;
      /* Smaller arrow */
      padding-right: 20px;
      /* Extra padding on the right */
    }

    select:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #18A0FB;
      box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.1);
    }

    #collection {
      width: 150px;
    }

    .collection-form-group,
    .naming-form-group,
    .custom-name-form-group,
    .duplicate-form-group,
    #groups-container,
    #modes-container {
      display: flex !important;
      flex-direction: row !important;
      gap: 8px;
      align-items: flex-start;
    }

    .collection-form-group label,
    .naming-form-group label,
    .custom-name-form-group label,
    .duplicate-form-group label,
    #groups-container label,
    #modes-container label,
    .dropdown-label {
      flex-shrink: 0;
      width: 70px;
      margin-bottom: 0;
      padding-top: 2px;
    }

    #collection,
    #naming-mode,
    #groups,
    #modes {
      width: 150px;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
      /* Reduced from 6px to 2px */
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .radio-option input[type="radio"],
    .radio-option input[type="checkbox"] {
      margin: 0;
    }

    .radio-option label {
      font-weight: normal;
      margin: 0;
      cursor: pointer;
      font-size: 12px;
    }

    button {
      border-radius: 4px;
      padding: 8px 16px;
      background: #18A0FB;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      font-family: Inter, sans-serif;
      width: 100%;
      margin-top: 0;
    }

    button:hover {
      background: #0D8EE9;
    }

    .hidden {
      display: none;
    }

    .info-text {
      font-size: 11px;
      color: #666;
      line-height: 1.4;
      /* margin-top: 2px; */
      /* background: #F0
      /* padding: 8px 10px; */
      /* border-radius: 4px; */
      /* border-left: 3px solid #18A0FB; */
    }

    .expandable-panel {
      /* border: 1px solid #E5E5E5; */
      border-radius: 4px;
      overflow: hidden;
      font-size: 11px;
      color: #333;
    }

    .clickable-text {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: start;
      font-size: 11px;
      font-weight: 500;
      color: #7f7f7f;
      user-select: none;
      gap: 6px;
      padding: 4px 0;
      transition: color 0.2s ease;
    }

    .clickable-text:hover {
      color: #18A0FB;
    }

    .expandable-content {
      background-color: #f5f5f5;
      border-radius: 4px;
      padding: 8px;
      margin-top: 4px;
      display: none;
      max-width: 100%;
      box-sizing: border-box;
    }

    .expandable-content.expanded {
      display: block;
    }

    .expandable-content .radio-option label {
      font-size: 11px;
      color: #333;
    }

    .expandable-content .info-text {
      font-size: 11px;
      color: #666;
      line-height: 1.4;
      margin-top: 0;
      /* Remove the top margin */
      margin-bottom: 4px;
      /* Add small bottom margin for spacing between groups */
    }

    .expandable-arrow {
      width: 8px;
      height: 6px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 6"><path fill="none" stroke="%23666" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M2 2l3 3 3-3"/></svg>');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 8px;
      transition: transform 0.2s ease;
      transform: rotate(-90deg);
      /* Start pointing right */
    }

    .clickable-text:hover .expandable-arrow {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 6"><path fill="none" stroke="%2318A0FB" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M2 2l3 3 3-3"/></svg>');
    }

    .expandable-arrow.expanded {
      transform: rotate(0deg);
      /* Point down when expanded */
    }

    .section-heading {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin: 0 0 8px 0;
      font-family: Inter, sans-serif;
    }

    .step {
      font-size: 11px;
      color: #333;
      line-height: 1.4;
      margin-bottom: 16px;
    }

    .step-row {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      align-items: flex-start;
    }

    .step-number {
      font-size: 14px;
      /* font-weight: 600; */
      color: #333;
      min-width: 20px;
      flex-shrink: 0;
      line-height: 1.4;
      /* padding-top: 1px; */
    }

    .step-content {
      font-size: 11px;
      color: #333;
      line-height: 1.4;
      flex: 1;
    }

    .step-heading {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .step-content .form-group {
      margin-top: 8px;
    }

    input[type="text"].error {
      border-color: #D7354A;
      box-shadow: 0 0 0 2px rgba(255, 59, 48, 0.1);
    }

    label.error {
      color: #D7354A;
    }

    .error-message {
      color: #D7354A;
      font-size: 11px;
      display: none;
    }

    /* Add new style for custom options indentation */
    .custom-options {
      margin-left: 18px;
      /* This matches the space taken by the radio button */
    }

    .radio-description {
      color: #7f7f7f;
      font-size: 11px;
      margin-left: 18px;
      margin-top: 0px;
    }

    .radio-group-item {
      margin-bottom: 4px;
      /* Add spacing between radio groups */
    }

    .radio-group-item:last-child {
      margin-bottom: 0;
      /* Remove margin from last item */
    }

    .radio-group-inline {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }

  </style>
</head>

<body>
  <div class="container">
    <div class="form-content">
      <div class="plugin-description">
        This plugin converts the fill of selected layers to color variables.
      </div>

      <div class="step-row">
        <div class="step-number">üé®</div>
        <div class="step-content">
          <div class="step-heading">Pick color layers</div>
          Select 1 or several layers with a color fill.
        </div>
      </div>

      <div class="step-row">
        <div class="step-number">‚úèÔ∏è</div>
        <div class="step-content">
          <div class="step-heading">Name your variables</div>
          Select 1 or several text layers to use their text as variable names. They must be grouped with their
          corresponding color layer.
          <p>If no text layer is selected, the plugin will default to one of the options below.</p>

          <div class="naming-form-group" style="margin-top: 12px;">
            <label for="naming-mode" class="dropdown-label">Options</label>
            <select id="naming-mode">
              <option value="auto">Best guess</option>
              <option value="layer-name">Layer name</option>
              <option value="figma-default">Figma default</option>
              <option value="manual">Custom</option>
            </select>
          </div>

          <div class="info-text" id="naming-description" style="margin-top: 4px; margin-left: 78px;">
            Analyzes color values to determine the closest base color, and adds lightness scale and saturation
            descriptor (e.g., blue-300-vivid, red-500-muted). May require manual updates.
          </div>

          <div class="custom-options hidden" id="custom-name-row" style="margin-top: 8px;">
            <div class="custom-name-form-group">
              <label for="custom-name" class="dropdown-label">Name</label>
              <input type="text" id="custom-name" placeholder="My color">
            </div>
            <span class="error-message" id="name-error" style="margin-left: 78px;">Enter a variable name</span>

            <div class="duplicate-form-group" style="margin-top: 8px;">
              <label class="dropdown-label">If duplicates</label>
              <div class="radio-group-inline">
                <div class="radio-option">
                  <input type="radio" id="append-increment" name="append-mode" value="increment" checked>
                  <label for="append-increment">Append increment</label>
                </div>
                <div class="radio-description">My color, My color 2</div>

                <div class="radio-option" style="margin-top: 4px;">
                  <input type="radio" id="append-color" name="append-mode" value="color">
                  <label for="append-color">Append best guess</label>
                </div>
                <div class="radio-description">My color red-500-vivid</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="step-row">
        <div class="step-number">üìÅ</div>
        <div class="step-content">
          <div class="step-heading">Choose destination</div>
          Choose which collection, group and variable mode to save the variable to.
          <div class="collection-form-group" style="margin-top: 12px;">
            <label for="collection" class="dropdown-label">Collection</label>
            <select id="collection">
              <option value="new">Create new collection</option>
            </select>
          </div>

          <!-- Groups dropdown -->
          <div id="groups-container" style="margin-top: 8px; display: none;">
            <label for="groups" class="dropdown-label">Group</label>
            <select id="groups">
              <option value="">All Variables</option>
            </select>
          </div>

          <!-- Modes dropdown -->
          <div id="modes-container" style="margin-top: 8px; display: none;">
            <label for="modes" class="dropdown-label">Mode</label>
            <select id="modes">
            </select>
          </div>
        </div>
      </div>
    </div>
    <button id="create">Create Variable</button>
  </div>
  <script>
    // Initialize by requesting collections
    parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');

    // Handle collections data
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg.type === 'update-collections') {
        updateCollectionsDropdown(msg.collections, msg.defaultCollectionId);
      } else if (msg.type === 'collection-created') {
        // Add the newly created collection to the dropdown and select it
        addNewCollectionToDropdown(msg.collection);
      } else if (msg.type === 'update-collection-details') {
        updateGroupsAndModes(msg.groups, msg.modes);
      } else if (msg.type === 'group-created') {
        addNewGroupToDropdown(msg.group);
      }
    };

    function updateCollectionsDropdown(collections, defaultCollectionId = null) {
      const select = document.getElementById('collection');
      select.innerHTML = '';

      let hasDefault = false;

      // Add existing collections first
      collections.forEach(collection => {
        const option = document.createElement('option');
        option.value = collection.id;
        option.textContent = collection.name;

        // Select the default collection if specified
        if (defaultCollectionId === collection.id) {
          option.selected = true;
          hasDefault = true;
        }

        select.appendChild(option);
      });

      // Add "Create new collection" option at the end
      const newOption = document.createElement('option');
      newOption.value = 'new';
      newOption.textContent = 'Create new collection';

      // Only select "Create new collection" if no default was found and no collections exist
      if (!hasDefault && collections.length === 0) {
        newOption.selected = true;
      }

      select.appendChild(newOption);

      // Request collection details for the selected collection
      if (hasDefault && defaultCollectionId) {
        requestCollectionDetails(defaultCollectionId);
      }

      // Add change event listener to collection dropdown
      select.addEventListener('change', (event) => {
        const selectedCollectionId = event.target.value;
        if (selectedCollectionId && selectedCollectionId !== 'new') {
          requestCollectionDetails(selectedCollectionId);
        } else {
          hideGroupsAndModes();
        }
      });
    }

    function addNewCollectionToDropdown(newCollection) {
      const select = document.getElementById('collection');

      // Remove the "Create new collection" option temporarily
      const createNewOption = select.querySelector('option[value="new"]');
      if (createNewOption) {
        createNewOption.remove();
      }

      // Add the new collection
      const option = document.createElement('option');
      option.value = newCollection.id;
      option.textContent = newCollection.name;
      option.selected = true; // Select the newly created collection
      select.appendChild(option);

      // Re-add "Create new collection" option at the end
      const newOption = document.createElement('option');
      newOption.value = 'new';
      newOption.textContent = 'Create new collection';
      select.appendChild(newOption);

      // Request details for the newly created collection
      requestCollectionDetails(newCollection.id);
    }

    function requestCollectionDetails(collectionId) {
      parent.postMessage({
        pluginMessage: {
          type: 'get-collection-details',
          collectionId: collectionId
        }
      }, '*');
    }

    function updateGroupsAndModes(groups, modes) {
      const groupsContainer = document.getElementById('groups-container');
      const modesContainer = document.getElementById('modes-container');
      const groupsSelect = document.getElementById('groups');
      const modesSelect = document.getElementById('modes');

      // Update groups dropdown
      groupsSelect.innerHTML = '<option value="">All variables</option>';
      groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        groupsSelect.appendChild(option);
      });

      // Add "Create new group" option at the end
      const createGroupOption = document.createElement('option');
      createGroupOption.value = 'create-new-group';
      createGroupOption.textContent = 'Create new group';
      groupsSelect.appendChild(createGroupOption);

      // Update modes dropdown
      modesSelect.innerHTML = '';
      modes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode.id;
        option.textContent = mode.name;
        modesSelect.appendChild(option);
      });

      // Show the dropdowns if there are groups or modes
      // Always show groups dropdown since we have "Create new group" option
      groupsContainer.style.display = 'block';

      if (modes.length > 0) {
        modesContainer.style.display = 'block';
        // Select the first mode by default if available
        if (modes.length === 1) {
          modesSelect.value = modes[0].id;
        }
      } else {
        modesContainer.style.display = 'none';
      }

      // Add event listener to groups dropdown (no immediate action needed)
      groupsSelect.removeEventListener('change', handleGroupsChange); // Remove existing listener if any
    }

    function addNewGroupToDropdown(newGroup) {
      const groupsSelect = document.getElementById('groups');

      // Remove the "Create new group" option temporarily
      const createNewOption = groupsSelect.querySelector('option[value="create-new-group"]');
      if (createNewOption) {
        createNewOption.remove();
      }

      // Add the new group
      const option = document.createElement('option');
      option.value = newGroup.id;
      option.textContent = newGroup.name;
      option.selected = true; // Select the newly created group
      groupsSelect.appendChild(option);

      // Re-add "Create new group" option at the end
      const createGroupOption = document.createElement('option');
      createGroupOption.value = 'create-new-group';
      createGroupOption.textContent = 'Create new group';
      groupsSelect.appendChild(createGroupOption);
    }

    function hideGroupsAndModes() {
      document.getElementById('groups-container').style.display = 'none';
      document.getElementById('modes-container').style.display = 'none';
    }

    document.getElementById('create').onclick = () => {
      const namingMode = document.getElementById('naming-mode').value;
      const customNameInput = document.getElementById('custom-name');
      const customNameLabel = document.querySelector('label[for="custom-name"]');
      const errorMessage = document.getElementById('name-error');

      // Validate custom name when manual mode is selected
      if (namingMode === 'manual') {
        const customName = customNameInput.value.trim();
        if (!customName) {
          // Add error styling to both input and label
          customNameInput.classList.add('error');
          customNameLabel.classList.add('error');
          errorMessage.style.display = 'block';
          return;
        }
        // Remove error styling if valid
        customNameInput.classList.remove('error');
        customNameLabel.classList.remove('error');
        errorMessage.style.display = 'none';
      }

      // Get selected group and mode
      const selectedGroup = document.getElementById('groups').value;
      const selectedMode = document.getElementById('modes').value;

      // Check if user wants to create a new group
      const createNewGroup = selectedGroup === 'create-new-group';

      parent.postMessage({
        pluginMessage: {
          type: 'create-variable',
          collectionId: document.getElementById('collection').value,
          namingMode: namingMode,
          customName: customNameInput.value,
          appendMode: document.querySelector('input[name="append-mode"]:checked')?.value,
          groupId: createNewGroup ? undefined : (selectedGroup || undefined),
          modeId: selectedMode || undefined,
          createNewGroup: createNewGroup
        }
      }, '*');
    };

    // Add input handler to remove error state when user starts typing
    document.getElementById('custom-name').addEventListener('input', (e) => {
      e.target.classList.remove('error');
      document.querySelector('label[for="custom-name"]').classList.remove('error');
      document.getElementById('name-error').style.display = 'none';
    });

    // Initialize naming mode description and event listener
    function updateNamingDescription() {
      const namingMode = document.getElementById('naming-mode').value;
      const descriptionElement = document.getElementById('naming-description');

      const descriptions = {
        'auto': 'Analyzes color values to determine the closest base color, and adds lightness scale and saturation descriptor (e.g., blue-300-vivid, red-500-muted). May require manual updates.',
        'layer-name': 'Uses the name of each color layer as the variable name.',
        'figma-default': 'Color, Color 2...',
        'manual': 'Enter a custom name for your variable.'
      };

      if (descriptionElement) {
        descriptionElement.textContent = descriptions[namingMode];
      }
    }

    // Wait for DOM to be ready, then attach event listener
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeNamingMode);
    } else {
      initializeNamingMode();
    }

    function initializeNamingMode() {
      const namingModeSelect = document.getElementById('naming-mode');
      if (!namingModeSelect) return;

      const customNameRow = document.getElementById('custom-name-row');
      const customNameInput = document.getElementById('custom-name');

      // Initialize description and custom row visibility
      updateNamingDescription();
      if (namingModeSelect.value === 'manual') {
        customNameRow?.classList.remove('hidden');
      } else {
        customNameRow?.classList.add('hidden');
      }

      namingModeSelect.addEventListener('change', (event) => {
        console.debug('naming-mode changed to', event.target.value);
        updateNamingDescription();
        if (event.target.value === 'manual') {
          customNameRow?.classList.remove('hidden');
          customNameInput?.focus();
        } else {
          customNameRow?.classList.add('hidden');
        }
      });
    }
  </script>
</body>

</html>
